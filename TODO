add checks for malloc
optimize libbatch.so by combining the 4 append_active_indices
